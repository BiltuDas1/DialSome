name: Release and Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'android/AndroidManifest.xml'

permissions:
  contents: write
  packages: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      is_prerelease: ${{ steps.version.outputs.IS_PRERELEASE }}
      skip: ${{ steps.check_release.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: bash .github/scripts/get-version.sh

      - name: Check for existing release
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: bash .github/scripts/check-release.sh

  build_android:
    needs: check
    if: needs.check.outputs.skip == 'false'
    uses: ./.github/workflows/build-android.yml
    with:
      version: ${{ needs.check.outputs.version }}
    secrets: inherit

  build_docker:
    needs: check
    if: needs.check.outputs.skip == 'false'
    uses: ./.github/workflows/build-docker.yml
    with:
      version: ${{ needs.check.outputs.version }}
    secrets: inherit

  publish:
    needs: [check, build_android, build_docker]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download APK Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: release-apk-*
          merge-multiple: true

      - name: Generate Changelog
        run: bash .github/scripts/generate-changelog.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ needs.check.outputs.version }}
          name: Release ${{ needs.check.outputs.version }}
          body_path: changelog.md
          prerelease: ${{ needs.check.outputs.is_prerelease == 'true' }}
          files: ./artifacts/*.apk
        env:
          GITHUB_TOKEN: ${{ github.token }}
